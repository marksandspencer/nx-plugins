name: PR validation

on:
  pull_request:
    types: [ready_for_review, opened, synchronize, reopened]
    branches:
      - main

jobs:
  build:
    name: PR validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Scan for secrets
        uses: edplato/trufflehog-actions-scan@master
        with:
          scanArguments: '--regex -x=truffle-hog-exclude.txt'

      - uses: ./.github/actions/prepare

      - name: Run linters
        run: pnpm nx run-many --target=lint --all

      - name: Run unit tests
        run: pnpm nx run-many --target=test --codeCoverage --all

      - name: Build plugin
        run: pnpm nx build nx-playwright

      - name: Check version
        run: pnpm ts-node ci/version-check

      - name: Test plugin generation
        run: |
          NX_WORKSPACE=test-nx
          NX_APP=test-app

          pushd ..
          echo "Create a new workspace to test with"
          pnpm create nx-workspace \
            --name=$NX_WORKSPACE --appName=$NX_APP \
            --preset=next --style=@emotion/styled \
            --nxCloud=false --interactive=false < /dev/null

          pushd $NX_WORKSPACE

          pnpm playwright install --with-deps  

          echo "Remove autogenerated e2e app"
          pnpm nx generate remove $NX_APP-e2e
          git \
            -c user.name="pr-bot" \
            -c user.email="pr-bot@mnscorp.net" \
            commit -am "Remove $NX_APP-e2e"
          popd
          popd

          echo "Test ./local-test.sh (with cleanup flag)"
          ./local-test.sh -w ../$NX_WORKSPACE -a $NX_APP
          test -z "$(git status --porcelain)"
